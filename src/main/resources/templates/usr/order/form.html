<html layout:decorate="~{usr/layout/layout.html}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head>
    <title>주문</title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
</head>

<body>
<main layout:fragment="main">
    <div class="hero-content flex flex-col my-10 w-[32rem]">
        <h1 class="text-2xl font-bold">
            주문
        </h1>

        <div class="flex flex-col gap-5 w-full max-w-md mb-10 mt-5">
            <div class="text-lg" th:text="${orderResponse.name}"></div>
            <div th:each="orderItem, loop : ${orderResponse.orderItems}">
                <div class="bg-base-100 border-b border-gray-200 p-5 ">
                    <div class="flex justify-around gap-5">
                        <div class="border border-gray-200 w-2/6 p-5">
                            이미지
                        </div>
                        <div class="flex flex-col gap-3 w-4/6">
                            <div class="flex flex-col gap-1">
                                <h3 th:text="${orderItem.product.seller.name}"></h3>
                                <a th:text="${orderItem.product.name}"
                                   class="text-xl font-bold "></a>
                            </div>
                            <div class="flex gap-3 justify-between">
                                <span class="text-lg" th:text="${orderItem.quantity} + '개'"></span>
                                <span class="text-lg"
                                      th:text="${#numbers.formatInteger(orderItem.product.price * orderItem.quantity, 0, 'COMMA') + '원'}"></span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="flex flex-col gap-2 mt-10">
                <div class="flex justify-between">
                    <span class="text-lg font-bold">총 주문 금액</span>
                    <span class="text-lg font-bold" id="totalPrice" th:value="${orderResponse.totalPrice}"
                          th:text="${#numbers.formatInteger(orderResponse.totalPrice, 0, 'COMMA') + '원'}"></span>
                </div>
            </div>
            <form class="flex flex-col gap-2" id="addressRequest">
                <h3 class="text-lg font-bold mb-2 mt-10">배송 정보 입력</h3>
                <div class="flex items-center">
                    <span class="w-1/3">수령인 이름</span>
                    <input class="input input-bordered w-2/3" id="receiverName" name="receiverName" type="text" placeholder="수령인 이름">
                </div>
                <div class="flex items-center">
                    <span class="w-1/3">수령인 전화번호</span>
                    <input class="input input-bordered w-2/3" id="phoneNumber" name="phoneNumber" type="text" placeholder="-제외 숫자만 입력해주세요">
                </div>
                <div class="mt-2 mb-1">배송지 주소</div>
                <div class="flex gap-2">
                    <input class="input input-bordered w-1/3" type="text" id="postCode" name="postCode" placeholder="우편번호" readonly>
                    <input class="btn" type="button" onclick="execDaumPostcode()" value="우편번호 찾기">
                </div>
                <input class="input input-bordered" type="text" id="address" name="address" placeholder="주소" readonly>
                <input class="input input-bordered" type="text" id="detailAddress" name="detailAddress" placeholder="상세주소">
            </form>


            <button id="payment-button" class="btn btn-lg btn-info">토스 페이먼츠로 결제하기</button>
        </div>

    </div>
    <script th:inline="javascript">

        var clientKey = 'test_ck_LBa5PzR0Arn52WnNaBoVvmYnNeDM'
        var tossPayments = TossPayments(clientKey)

        var button = document.getElementById('payment-button') // 결제하기 버튼
        var amount = /*[[${orderResponse.totalPrice}]]*/null
        var orderId = /*[[${orderResponse.orderId}]]*/null
        var orderName = /*[[${orderResponse.name}]]*/null
        var customerName = /*[[${orderResponse.buyerName}]]*/null

        button.addEventListener('click', function () {
            if (AddressRequest__submit(document.getElementById('addressRequest'))) {

                var addressRequest = {
                    memberId : /*[[${@rq.member.id}]]*/null,
                    receiverName: document.getElementById('receiverName').value,
                    address: document.getElementById('address').value,
                    detailAddress: document.getElementById('detailAddress').value,
                    postCode: document.getElementById('postCode').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    isDefault: false
                };

                var encodedAddressRequest = encodeURIComponent(JSON.stringify(addressRequest));


                tossPayments.requestPayment('카드', {
                    amount: amount,
                    orderId: orderId + "_" + (Math.random() + "").substring(2),
                    orderName: orderName,
                    customerName: customerName,
                    addressRequest : addressRequest,
                    successUrl: window.location.origin + "/order/" + orderId + "/success?addressRequest=" + encodedAddressRequest,
                    failUrl:  window.location.origin + "/order/" + orderId + "/fail"
                });

            }
        })

        function AddressRequest__submit(form){
            // var address = document.getElementById('address').value;
            // var detailAddress = document.getElementById('detailAddress').value;
            // var postcode = document.getElementById('postCode').value;
            // var phoneNumber = document.getElementById('phoneNumber').value;
            // var receiverName = document.getElementById('receiverName').value;

            form.receiverName.value = form.receiverName.value.trim();

            if (form.receiverName.value.length === 0) {
                toastWarning("수령인 이름을 입력해주세요");
                form.receiverName.focus();
                return false;
            }

            form.phoneNumber.value = form.phoneNumber.value.trim();

            if (form.phoneNumber.value.length === 0) {
                toastWarning("수령인 전화번호를 입력해주세요");
                form.phoneNumber.focus();
                return false;
            }

            form.postCode.value = form.postCode.value.trim();

            if (form.postCode.value.length === 0) {
                toastWarning("우편번호를 입력해주세요");
                form.postCode.focus();
                return false;
            }

            form.address.value = form.address.value.trim();

            if (form.address.value.length === 0) {
                toastWarning("주소를 입력해주세요");
                form.address.focus();
                return false;
            }

            form.detailAddress.value = form.detailAddress.value.trim();

            if (form.detailAddress.value.length === 0) {
                toastWarning("상세주소를 입력해주세요");
                form.detailAddress.focus();
                return false;
            }

            return true;
        }
    </script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {

                    var addr = ''; // 주소 변수

                    if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                        addr = data.roadAddress;
                    } else { // 사용자가 지번 주소를 선택했을 경우(J)
                        addr = data.jibunAddress;
                    }

                    document.getElementById('postCode').value = data.zonecode;
                    document.getElementById("address").value = addr;

                    // 커서를 상세주소 필드로 이동
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }
    </script>

</main>
</body>

</html>
